<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculateur de masse moléculaire complet pour les lycéens en Terminale D">
    <meta name="theme-color" content="#3b82f6">
    <title>Moleculator Pro - Calculateur de masse moléculaire avancé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --dark-bg: #1e293b;
            --dark-text: #e2e8f0;
        }

        .dark {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .element-card {
            transition: all 0.2s ease;
        }

        .element-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .formula-input {
            font-family: 'Courier New', monospace;
        }

        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .explanation-content.show {
            max-height: 1000px;
        }

        .formula-display {
            font-family: 'Courier New', monospace;
        }

        .formula-display sub {
            vertical-align: sub;
            font-size: 0.8em;
        }

        .formula-display sup {
            vertical-align: super;
            font-size: 0.8em;
        }

        .atom-sphere {
            position: relative;
            width: 100%;
            height: 300px;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .history-item {
            transition: all 0.2s;
            cursor: pointer;
        }

        .history-item:hover {
            background-color: #f1f5f9;
            transform: translateX(4px);
        }

        .dark .history-item:hover {
            background-color: #334155;
        }

        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
            }
            
            .mobile-stack > * {
                width: 100% !important;
                margin-bottom: 0.5rem;
            }
            
            .atom-sphere {
                height: 220px;
            }
        }

        /* Animation pour le mode examen */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .exam-mode {
            animation: pulse 2s infinite;
            border: 2px solid #ef4444;
        }
        
        .molecule-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        #moleculeCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .view-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .view-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .view-btn:hover {
            background: rgba(255, 255, 255, 1);
        }

        .dark .view-btn {
            background: rgba(30, 41, 59, 0.8);
            color: white;
        }

        .dark .view-btn:hover {
            background: rgba(30, 41, 59, 1);
        }

        .element-highlight {
            background-color: #dbeafe;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .dark .element-highlight {
            background-color: #1e3a8a;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col dark:bg-gray-900 dark:text-gray-200">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-md dark:bg-blue-800">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-atom text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold">Moleculator Pro</h1>
            </div>
            <nav>
                <ul class="flex space-x-4 items-center">
                    <li>
                        <button id="examModeToggle" class="p-2 rounded-full hover:bg-blue-700 transition dark:hover:bg-blue-900" title="Mode examen">
                            <i class="fas fa-graduation-cap"></i>
                        </button>
                    </li>
                    <li>
                        <button id="nightModeToggle" class="p-2 rounded-full hover:bg-blue-700 transition dark:hover:bg-blue-900" title="Mode nuit">
                            <i class="fas fa-moon"></i>
                        </button>
                    </li>
                    <li>
                        <button id="infoBtn" class="p-2 rounded-full hover:bg-blue-700 transition dark:hover:bg-blue-900" title="À propos">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Hero Section -->
            <section class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-blue-700 mb-4 dark:text-blue-400">Calculateur de masse moléculaire</h2>
                <p class="text-lg text-gray-600 mb-6 dark:text-gray-300">Entrez une formule chimique pour calculer sa masse moléculaire et obtenir une explication détaillée.</p>
                
                <!-- Formula Input -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8 dark:bg-gray-800" id="inputSection">
                    <div class="flex mobile-stack">
                        <input type="text" id="formulaInput" 
                               class="formula-input flex-grow px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                               placeholder="Ex: H2O, NaCl, C6H12O6, Ca(OH)2, SO4^2-..." autocomplete="off" autocapitalize="off" value="H2SO4">
                        <button id="calculateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 rounded-r-lg transition dark:bg-blue-700 dark:hover:bg-blue-800">
                            Calculer <i class="fas fa-calculator ml-2"></i>
                        </button>
                    </div>
                    
                    <!-- Sélecteur d'exemples -->
                    <div class="mt-4 flex flex-wrap gap-2 justify-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Exemples :</span>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="H2O">H₂O</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="NaCl">NaCl</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="C6H12O6">C₆H₁₂O₆</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="Ca(OH)2">Ca(OH)₂</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="H2SO4">H₂SO₄</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="CO2">CO₂</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="CuSO4·5H2O">CuSO₄·5H₂O</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="NH4+">NH₄⁺</button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded dark:bg-gray-700 dark:hover:bg-gray-600" data-formula="C2H5OH">C₂H₅OH</button>
                    </div>
                    
                    <p id="inputError" class="text-red-500 mt-2 text-sm hidden dark:text-red-400"></p>
                </div>
            </section>

            <!-- Results Section -->
            <section id="resultsSection" class="bg-white rounded-lg shadow-md p-6 mb-8 dark:bg-gray-800">
                <h3 class="text-xl font-semibold text-blue-700 mb-4 dark:text-blue-400">Résultats</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Formula Card -->
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 dark:bg-blue-900/20 dark:border-blue-800/30">
                        <h4 class="font-medium text-blue-800 mb-2 dark:text-blue-300">Formule</h4>
                        <p id="formulaDisplay" class="text-2xl font-bold text-blue-600 dark:text-blue-400 formula-display">H₂SO₄</p>
                    </div>
                    
                    <!-- Molar Mass Card -->
                    <div class="bg-green-50 border border-green-100 rounded-lg p-4 dark:bg-green-900/20 dark:border-green-800/30">
                        <h4 class="font-medium text-green-800 mb-2 dark:text-green-300">Masse molaire</h4>
                        <p id="molarMassDisplay" class="text-2xl font-bold text-green-600 dark:text-green-400">98.079 g/mol</p>
                    </div>
                    
                    <!-- Unit Card -->
                    <div class="bg-purple-50 border border-purple-100 rounded-lg p-4 dark:bg-purple-900/20 dark:border-purple-800/30">
                        <h4 class="font-medium text-purple-800 mb-2 dark:text-purple-300">Unité</h4>
                        <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">g/mol</p>
                    </div>
                </div>
                
                <!-- Visualisation moléculaire -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3 dark:text-gray-300">Représentation moléculaire</h4>
                    <div id="moleculeViz" class="atom-sphere">
                        <canvas id="moleculeCanvas"></canvas>
                        <div class="view-controls">
                            <button id="resetViewBtn" class="view-btn" title="Réinitialiser la vue">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="toggleLabelsBtn" class="view-btn" title="Afficher/Masquer les étiquettes">
                                <i class="fas fa-tag"></i>
                            </button>
                        </div>
                    </div>
                    <p id="moleculeCaption" class="text-sm text-gray-500 mt-2 text-center dark:text-gray-400">Acide sulfurique (H₂SO₄)</p>
                </div>
                
                <!-- Calculation Steps -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3 dark:text-gray-300">Détails du calcul</h4>
                    <div id="calculationSteps" class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded dark:bg-gray-700">
                            <span class="font-mono">H<sub>2</sub></span>
                            <span class="text-gray-500">=</span>
                            <span>2 × 1.008 g/mol</span>
                            <span class="text-gray-500">=</span>
                            <span class="font-bold">2.016 g/mol</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded dark:bg-gray-700">
                            <span class="font-mono">S</span>
                            <span class="text-gray-500">=</span>
                            <span>1 × 32.060 g/mol</span>
                            <span class="text-gray-500">=</span>
                            <span class="font-bold">32.060 g/mol</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded dark:bg-gray-700">
                            <span class="font-mono">O<sub>4</sub></span>
                            <span class="text-gray-500">=</span>
                            <span>4 × 15.999 g/mol</span>
                            <span class="text-gray-500">=</span>
                            <span class="font-bold">63.996 g/mol</span>
                        </div>
                        <div class="flex justify-between items-center bg-blue-50 p-3 rounded border border-blue-100 dark:bg-blue-900/30 dark:border-blue-800/30">
                            <span class="font-bold">Total</span>
                            <span class="text-gray-500">=</span>
                            <span></span>
                            <span class="text-gray-500">=</span>
                            <span class="font-bold text-blue-700 dark:text-blue-400">98.072 g/mol</span>
                        </div>
                    </div>
                </div>
                
                <!-- Composition massique -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3 dark:text-gray-300">Composition massique</h4>
                    <div id="massComposition" class="space-y-3">
                        <div class="mb-2">
                            <div class="flex justify-between mb-1">
                                <span class="font-medium">H - Hydrogène</span>
                                <span>2.06%</span>
                            </div>
                            <div class="progress-bar bg-gray-200 dark:bg-gray-700">
                                <div class="h-full bg-blue-500" style="width: 2.06%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between mb-1">
                                <span class="font-medium">S - Soufre</span>
                                <span>32.69%</span>
                            </div>
                            <div class="progress-bar bg-gray-200 dark:bg-gray-700">
                                <div class="h-full bg-green-500" style="width: 32.69%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between mb-1">
                                <span class="font-medium">O - Oxygène</span>
                                <span>65.25%</span>
                            </div>
                            <div class="progress-bar bg-gray-200 dark:bg-gray-700">
                                <div class="h-full bg-red-500" style="width: 65.25%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Explanation -->
                <div class="border-t border-gray-200 pt-4 dark:border-gray-700">
                    <button id="explanationToggle" class="flex items-center justify-between w-full text-left font-semibold text-blue-700 hover:text-blue-800 mb-2 dark:text-blue-400 dark:hover:text-blue-300">
                        <span>Explication détaillée</span>
                        <i class="fas fa-chevron-down transition-transform duration-300"></i>
                    </button>
                    <div id="explanationContent" class="explanation-content show">
                        <div id="detailedExplanation" class="prose max-w-none text-gray-700 dark:text-gray-300">
                            <h3>Calcul de la masse molaire de H₂SO₄</h3>
                            <p>La masse moléculaire (ou masse molaire) d'une substance est la somme des masses atomiques de tous les atomes qui composent sa formule chimique. Elle s'exprime en grammes par mole (g/mol).</p>
                            
                            <p>Pour calculer la masse moléculaire :</p>
                            <ol>
                                <li>Identifier chaque élément dans la formule</li>
                                <li>Trouver sa masse atomique</li>
                                <li>Multiplier par le nombre d'atomes</li>
                                <li>Additionner toutes les contributions</li>
                            </ol>
                            
                            <h4>Calcul détaillé pour H₂SO₄ :</h4>
                            <ul>
                                <li>2 atomes d'Hydrogène (H) : 2 × 1.008 g/mol = 2.016 g/mol</li>
                                <li>1 atome de Soufre (S) : 1 × 32.060 g/mol = 32.060 g/mol</li>
                                <li>4 atomes d'Oxygène (O) : 4 × 15.999 g/mol = 63.996 g/mol</li>
                            </ul>
                            
                            <p class="font-bold">Masse moléculaire totale : 2.016 + 32.060 + 63.996 = 98.072 g/mol</p>
                            
                            <h4>Composition massique :</h4>
                            <p>La composition massique indique le pourcentage de masse de chaque élément dans un composé :</p>
                            <ul>
                                <li>Hydrogène : (2.016 / 98.072) × 100 = 2.06%</li>
                                <li>Soufre : (32.060 / 98.072) × 100 = 32.69%</li>
                                <li>Oxygène : (63.996 / 98.072) × 100 = 65.25%</li>
                            </ul>
                            
                            <h4>Importance en chimie :</h4>
                            <p>La masse moléculaire est essentielle pour :</p>
                            <ul>
                                <li>Calculer les quantités de matière (moles)</li>
                                <li>Préparer des solutions de concentration donnée</li>
                                <li>Équilibrer des équations chimiques</li>
                                <li>Prévoir les quantités dans les réactions</li>
                            </ul>
                            
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg dark:bg-blue-900/20">
                                <h4 class="font-bold text-blue-800 dark:text-blue-300"><i class="fas fa-lightbulb mr-2"></i>Conseil pédagogique</h4>
                                <p>La masse atomique n'est pas un nombre entier car elle tient compte de l'abondance naturelle des différents isotopes de chaque élément. Par exemple, le chlore (Cl) a une masse atomique de 35.45 g/mol car il existe sous forme de ³⁵Cl (75%) et ³⁷Cl (25%).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Historique des calculs -->
            <section id="historySection" class="bg-white rounded-lg shadow-md p-6 mb-8 dark:bg-gray-800">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-blue-700 dark:text-blue-400">Historique des calculs</h3>
                    <button id="clearHistoryBtn" class="text-sm text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                        <i class="fas fa-trash mr-1"></i> Effacer
                    </button>
                </div>
                <div id="historyList" class="space-y-2">
                    <!-- Les éléments d'historique seront ajoutés dynamiquement -->
                </div>
            </section>

            <!-- Elements Table -->
            <section class="bg-white rounded-lg shadow-md p-6 mb-8 dark:bg-gray-800">
                <h3 class="text-xl font-semibold text-blue-700 mb-4 dark:text-blue-400">Masses atomiques des éléments</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Symbole</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Nom</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Masse atomique (g/mol)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Configuration électronique</th>
                            </tr>
                        </thead>
                        <tbody id="elementsTableBody" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                            <!-- Les éléments seront ajoutés dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t border-gray-200 py-6 dark:bg-gray-800 dark:border-gray-700">
        <div class="container mx-auto px-4 text-center text-gray-600 dark:text-gray-400">
            <p>© 2025 Moleculator Pro - Outil pédagogique pour les lycéens en Terminale D&C</p>
            <p class="text-sm mt-2">Données atomiques issues des valeurs IUPAC 2021</p>
        </div>
    </footer>

    <!-- Info Modal -->
    <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto dark:bg-gray-800">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-700 dark:text-blue-400">À propos de Moleculator Pro</h3>
                    <button id="closeInfoModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="prose dark:prose-invert">
                    <p>Moleculator Pro est un outil pédagogique conçu pour aider les élèves de Terminale D & C à comprendre et calculer les masses moléculaires.</p>
                    <p class="mt-2"><strong>Nouvelles fonctionnalités :</strong></p>
                    <ul class="list-disc pl-5">
                        <li>Calcul précis des masses moléculaires</li>
                        <li>Gestion des ions (charges électriques)</li>
                        <li>Représentation 3D interactive des molécules</li>
                        <li>Composition massique détaillée</li>
                        <li>Historique des calculs</li>
                        <li>Mode examen pour les évaluations</li>
                        <li>Base de données des éléments</li>
                    </ul>
                    <p class="mt-2"><strong>Comment utiliser :</strong></p>
                    <ol class="list-decimal pl-5">
                        <li>Entrez une formule chimique (ex: H2O, NaCl, SO4^2-)</li>
                        <li>Cliquez sur "Calculer"</li>
                        <li>Consultez le résultat, la composition et l'explication</li>
                        <li>Explorez la représentation 3D de la molécule</li>
                    </ol>
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg dark:bg-yellow-900/20">
                        <h4 class="font-bold text-yellow-800 dark:text-yellow-300"><i class="fas fa-lightbulb mr-2"></i>Conseil pédagogique</h4>
                        <p class="mt-1 text-sm">Utilisez le mode examen pour désactiver certaines aides pendant vos révisions ou évaluations.</p>
                    </div>
                    <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">Version 2.1.0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elements database with electron configurations
        const elements = [
            { symbol: "H", name: "Hydrogène", atomicMass: 1.008, config: "1s¹", color: "#FFAAAA", radius: 0.4 },
            { symbol: "He", name: "Hélium", atomicMass: 4.0026, config: "1s²", color: "#D9FFFF", radius: 0.3 },
            { symbol: "Li", name: "Lithium", atomicMass: 6.94, config: "[He] 2s¹", color: "#CC80FF", radius: 1.3 },
            { symbol: "Be", name: "Béryllium", atomicMass: 9.0122, config: "[He] 2s²", color: "#C2FF00", radius: 0.9 },
            { symbol: "B", name: "Bore", atomicMass: 10.81, config: "[He] 2s² 2p¹", color: "#FFB5B5", radius: 0.8 },
            { symbol: "C", name: "Carbone", atomicMass: 12.011, config: "[He] 2s² 2p²", color: "#909090", radius: 0.7 },
            { symbol: "N", name: "Azote", atomicMass: 14.007, config: "[He] 2s² 2p³", color: "#3050F8", radius: 0.7 },
            { symbol: "O", name: "Oxygène", atomicMass: 15.999, config: "[He] 2s² 2p⁴", color: "#FF0D0D", radius: 0.7 },
            { symbol: "F", name: "Fluor", atomicMass: 18.998, config: "[He] 2s² 2p⁵", color: "#90E050", radius: 0.7 },
            { symbol: "Ne", name: "Néon", atomicMass: 20.180, config: "[He] 2s² 2p⁶", color: "#B3E3F5", radius: 0.7 },
            { symbol: "Na", name: "Sodium", atomicMass: 22.990, config: "[Ne] 3s¹", color: "#AB5CF2", radius: 1.5 },
            { symbol: "Mg", name: "Magnésium", atomicMass: 24.305, config: "[Ne] 3s²", color: "#8AFF00", radius: 1.3 },
            { symbol: "Al", name: "Aluminium", atomicMass: 26.982, config: "[Ne] 3s² 3p¹", color: "#BFA6A6", radius: 1.2 },
            { symbol: "Si", name: "Silicium", atomicMass: 28.085, config: "[Ne] 3s² 3p²", color: "#F0C8A0", radius: 1.1 },
            { symbol: "P", name: "Phosphore", atomicMass: 30.974, config: "[Ne] 3s² 3p³", color: "#FF8000", radius: 1.1 },
            { symbol: "S", name: "Soufre", atomicMass: 32.06, config: "[Ne] 3s² 3p⁴", color: "#FFFF30", radius: 1.0 },
            { symbol: "Cl", name: "Chlore", atomicMass: 35.45, config: "[Ne] 3s² 3p⁵", color: "#1FF01F", radius: 1.0 },
            { symbol: "Ar", name: "Argon", atomicMass: 39.948, config: "[Ne] 3s² 3p⁶", color: "#80D1E3", radius: 0.9 },
            { symbol: "K", name: "Potassium", atomicMass: 39.098, config: "[Ar] 4s¹", color: "#8F40D4", radius: 2.0 },
            { symbol: "Ca", name: "Calcium", atomicMass: 40.078, config: "[Ar] 4s²", color: "#3DFF00", radius: 1.7 },
            { symbol: "Fe", name: "Fer", atomicMass: 55.845, config: "[Ar] 3d⁶ 4s²", color: "#E06633", radius: 1.2 },
            { symbol: "Cu", name: "Cuivre", atomicMass: 63.546, config: "[Ar] 3d¹⁰ 4s¹", color: "#C88033", radius: 1.3 },
        ];

        // Predefined molecules with 3D structure
        const predefinedMolecules = {
            "H2O": {
                atoms: [
                    { element: "O", x: 0, y: 0, z: 0 },
                    { element: "H", x: 0.76, y: 0.5, z: 0 },
                    { element: "H", x: -0.76, y: 0.5, z: 0 }
                ],
                bonds: [
                    { from: 0, to: 1 },
                    { from: 0, to: 2 }
                ],
                name: "Eau"
            },
            "CO2": {
                atoms: [
                    { element: "C", x: 0, y: 0, z: 0 },
                    { element: "O", x: 1.16, y: 0, z: 0 },
                    { element: "O", x: -1.16, y: 0, z: 0 }
                ],
                bonds: [
                    { from: 0, to: 1 },
                    { from: 0, to: 2 }
                ],
                name: "Dioxyde de carbone"
            },
            "NH3": {
                atoms: [
                    { element: "N", x: 0, y: 0, z: 0 },
                    { element: "H", x: 0.63, y: 0.6, z: 0 },
                    { element: "H", x: -0.63, y: 0.6, z: 0 },
                    { element: "H", x: 0, y: -0.6, z: 0.63 }
                ],
                bonds: [
                    { from: 0, to: 1 },
                    { from: 0, to: 2 },
                    { from: 0, to: 3 }
                ],
                name: "Ammoniac"
            },
            "CH4": {
                atoms: [
                    { element: "C", x: 0, y: 0, z: 0 },
                    { element: "H", x: 0.63, y: 0.63, z: 0.63 },
                    { element: "H", x: -0.63, y: -0.63, z: 0.63 },
                    { element: "H", x: 0.63, y: -0.63, z: -0.63 },
                    { element: "H", x: -0.63, y: 0.63, z: -0.63 }
                ],
                bonds: [
                    { from: 0, to: 1 },
                    { from: 0, to: 2 },
                    { from: 0, to: 3 },
                    { from: 0, to: 4 }
                ],
                name: "Méthane"
            },
            "C6H12O6": {
                atoms: [
                    { element: "C", x: 0, y: 0, z: 0 },
                    { element: "C", x: 1.5, y: 0, z: 0 },
                    { element: "C", x: 1.5, y: 1.5, z: 0 },
                    { element: "C", x: 0, y: 1.5, z: 0 },
                    { element: "C", x: -1.5, y: 1.5, z: 0 },
                    { element: "C", x: -1.5, y: 0, z: 0 },
                    { element: "O", x: 0, y: -1.5, z: 0 },
                    { element: "O", x: 1.5, y: -1.5, z: 0 },
                    { element: "O", x: -1.5, y: -1.5, z: 0 },
                    { element: "O", x: 0, y: 3, z: 0 },
                    { element: "O", x: 3, y: 1.5, z: 0 },
                    { element: "O", x: -3, y: 1.5, z: 0 },
                    { element: "H", x: 0.75, y: 0.75, z: 0.75 },
                    { element: "H", x: 0.75, y: 0.75, z: -0.75 },
                    { element: "H", x: 0.75, y: 2.25, z: 0.75 },
                    { element: "H", x: 0.75, y: 2.25, z: -0.75 },
                    { element: "H", x: -0.75, y: 2.25, z: 0.75 },
                    { element: "H", x: -0.75, y: 2.25, z: -0.75 },
                    { element: "H", x: -0.75, y: 0.75, z: 0.75 },
                    { element: "H", x: -0.75, y: 0.75, z: -0.75 },
                    { element: "H", x: 1.5, y: -0.75, z: 0 },
                    { element: "H", x: 0, y: -2.25, z: 0 },
                    { element: "H", x: -1.5, y: -0.75, z: 0 }
                ],
                bonds: [
                    // Simplified bonds for glucose
                    { from: 0, to: 1 }, { from: 1, to: 2 }, { from: 2, to: 3 }, 
                    { from: 3, to: 4 }, { from: 4, to: 5 }, { from: 5, to: 0 },
                    // Add oxygen bonds
                    { from: 0, to: 6 }, { from: 1, to: 7 }, { from: 5, to: 8 },
                    { from: 3, to: 9 }, { from: 2, to: 10 }, { from: 4, to: 11 },
                    // Add hydrogen bonds (simplified)
                    { from: 0, to: 12 }, { from: 1, to: 13 }, { from: 2, to: 14 },
                    { from: 3, to: 15 }, { from: 4, to: 16 }, { from: 5, to: 17 },
                    { from: 6, to: 21 }, { from: 7, to: 20 }, { from: 8, to: 22 }
                ],
                name: "Glucose"
            },
            "H2SO4": {
                atoms: [
                    { element: "S", x: 0, y: 0, z: 0 },
                    { element: "O", x: 1.4, y: 0, z: 0 },
                    { element: "O", x: -1.4, y: 0, z: 0 },
                    { element: "O", x: 0, y: 1.4, z: 0 },
                    { element: "O", x: 0, y: -1.4, z: 0 },
                    { element: "H", x: 0, y: 1.8, z: 0.8 },
                    { element: "H", x: 0, y: 1.8, z: -0.8 }
                ],
                bonds: [
                    { from: 0, to: 1 }, { from: 0, to: 2 }, { from: 0, to: 3 }, 
                    { from: 0, to: 4 }, { from: 3, to: 5 }, { from: 3, to: 6 }
                ],
                name: "Acide sulfurique"
            }
        };

        // DOM Elements
        const formulaInput = document.getElementById('formulaInput');
        const calculateBtn = document.getElementById('calculateBtn');
        const inputError = document.getElementById('inputError');
        const resultsSection = document.getElementById('resultsSection');
        const formulaDisplay = document.getElementById('formulaDisplay');
        const molarMassDisplay = document.getElementById('molarMassDisplay');
        const calculationSteps = document.getElementById('calculationSteps');
        const detailedExplanation = document.getElementById('detailedExplanation');
        const elementsTableBody = document.getElementById('elementsTableBody');
        const explanationToggle = document.getElementById('explanationToggle');
        const explanationContent = document.getElementById('explanationContent');
        const nightModeToggle = document.getElementById('nightModeToggle');
        const examModeToggle = document.getElementById('examModeToggle');
        const infoBtn = document.getElementById('infoBtn');
        const infoModal = document.getElementById('infoModal');
        const closeInfoModal = document.getElementById('closeInfoModal');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const massComposition = document.getElementById('massComposition');
        const moleculeCanvas = document.getElementById('moleculeCanvas');
        const resetViewBtn = document.getElementById('resetViewBtn');
        const toggleLabelsBtn = document.getElementById('toggleLabelsBtn');
        const moleculeCaption = document.getElementById('moleculeCaption');

        // Three.js variables
        let scene, camera, renderer, controls;
        let moleculeGroup = new THREE.Group();
        let showLabels = true;
        let currentFormula = "";

        // App state
        let isExamMode = false;
        let calculationHistory = JSON.parse(localStorage.getItem('molarMassHistory')) || [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            calculateBtn.addEventListener('click', calculateMolarMass);
            formulaInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') calculateMolarMass();
            });
            
            explanationToggle.addEventListener('click', toggleExplanation);
            nightModeToggle.addEventListener('click', toggleNightMode);
            examModeToggle.addEventListener('click', toggleExamMode);
            infoBtn.addEventListener('click', showInfoModal);
            closeInfoModal.addEventListener('click', hideInfoModal);
            clearHistoryBtn.addEventListener('click', clearHistory);
            resetViewBtn.addEventListener('click', resetView);
            toggleLabelsBtn.addEventListener('click', toggleLabels);
            
            // Setup example buttons
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    formulaInput.value = this.getAttribute('data-formula');
                    calculateMolarMass();
                });
            });
            
            // Initialize Three.js
            initThreeJS();
            
            // Render elements table
            renderElementsTable();
            
            // Render history if exists
            if (calculationHistory.length > 0) {
                historySection.classList.remove('hidden');
                renderHistory();
            }
            
            // Check night mode preference
            checkNightModePreference();
            
            // Calculate initial formula
            calculateMolarMass();
        });

        // Initialize Three.js scene
        function initThreeJS() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8fafc);
            scene.add(moleculeGroup);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, moleculeCanvas.clientWidth / moleculeCanvas.clientHeight, 0.1, 1000);
            camera.position.z = 15;
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ canvas: moleculeCanvas, antialias: true });
            renderer.setSize(moleculeCanvas.clientWidth, moleculeCanvas.clientHeight);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Add controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = moleculeCanvas.clientWidth / moleculeCanvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(moleculeCanvas.clientWidth, moleculeCanvas.clientHeight);
            });
        }

        // Render molecule in 3D
        function renderMolecule3D(formula) {
            // Clear previous molecule
            while(moleculeGroup.children.length > 0) { 
                moleculeGroup.remove(moleculeGroup.children[0]); 
            }
            
            // Get molecule definition
            const simpleFormula = formula.replace(/\^.*/, ''); // Remove charge
            let moleculeDef = predefinedMolecules[simpleFormula];
            
            if (!moleculeDef) {
                // Generate a default circular arrangement for unknown molecules
                const parsed = parseFormula(simpleFormula);
                const elements = Object.keys(parsed);
                const count = elements.length;
                const radius = count * 1.5; // Circle radius
                
                moleculeDef = { atoms: [], bonds: [], name: simpleFormula };
                let index = 0;
                
                for (const element in parsed) {
                    for (let i=0; i<parsed[element]; i++) {
                        const angle = (index * 2 * Math.PI) / count;
                        moleculeDef.atoms.push({
                            element,
                            x: radius * Math.cos(angle),
                            y: radius * Math.sin(angle),
                            z: 0
                        });
                        index++;
                    }
                }
            }
            
            // Set caption
            moleculeCaption.textContent = moleculeDef.name + " (" + formatFormula(formula) + ")";
            
            // Create atoms
            const atomMeshes = [];
            moleculeDef.atoms.forEach(atom => {
                const elementData = elements.find(e => e.symbol === atom.element);
                const color = elementData ? parseInt(elementData.color.substring(1), 16) : 0xFFFFFF;
                const radius = elementData ? elementData.radius : 0.5;
                
                const geometry = new THREE.SphereGeometry(radius, 32, 32);
                const material = new THREE.MeshPhongMaterial({ color });
                const sphere = new THREE.Mesh(geometry, material);
                
                sphere.position.set(atom.x, atom.y, atom.z);
                moleculeGroup.add(sphere);
                atomMeshes.push(sphere);
                
                // Add label
                if (showLabels) {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = 64;
                    canvas.height = 64;
                    
                    context.fillStyle = '#ffffff';
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    context.fillStyle = '#000000';
                    context.font = '40px Arial';
                    context.textAlign = 'center';
                    context.textBaseline = 'middle';
                    context.fillText(atom.element, canvas.width/2, canvas.height/2);
                    
                    const texture = new THREE.CanvasTexture(canvas);
                    const material2 = new THREE.SpriteMaterial({ map: texture });
                    const sprite = new THREE.Sprite(material2);
                    sprite.scale.set(1.2, 1.2, 1.2);
                    sprite.position.set(atom.x, atom.y, atom.z + radius + 0.3);
                    moleculeGroup.add(sprite);
                }
            });
            
            // Create bonds
            moleculeDef.bonds.forEach(bond => {
                if (bond.from < atomMeshes.length && bond.to < atomMeshes.length) {
                    const start = atomMeshes[bond.from].position;
                    const end = atomMeshes[bond.to].position;
                    
                    const distance = start.distanceTo(end);
                    const direction = new THREE.Vector3().subVectors(end, start).normalize();
                    const position = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
                    
                    // Create cylinder for bond
                    const geometry = new THREE.CylinderGeometry(0.1, 0.1, distance, 8);
                    geometry.translate(0, distance/2, 0);
                    const material = new THREE.MeshPhongMaterial({ color: 0x888888 });
                    const cylinder = new THREE.Mesh(geometry, material);
                    
                    // Orient the cylinder
                    const axis = new THREE.Vector3(0, 1, 0).cross(direction);
                    const angle = Math.acos(new THREE.Vector3(0, 1, 0).dot(direction));
                    cylinder.quaternion.setFromAxisAngle(axis, angle);
                    cylinder.position.copy(position);
                    
                    moleculeGroup.add(cylinder);
                }
            });
            
            // Reset camera position
            resetView();
        }

        // Reset 3D view
        function resetView() {
            camera.position.set(0, 0, 15);
            camera.lookAt(0, 0, 0);
            controls.reset();
        }

        // Toggle atom labels
        function toggleLabels() {
            showLabels = !showLabels;
            renderMolecule3D(currentFormula);
        }

        // Parse chemical formula into elements and counts (improved)
        function parseFormula(formula) {
            // Handle ions (remove charge for mass calculation)
            const chargeMatch = formula.match(/(.+)\^([+-]?\d*)/);
            let charge = 0;
            if (chargeMatch) {
                formula = chargeMatch[1];
                charge = chargeMatch[2] === '+' ? 1 : 
                         chargeMatch[2] === '-' ? -1 : 
                         chargeMatch[2] === '' ? 0 : parseInt(chargeMatch[2]);
            }
            
            // Handle hydrates
            if (formula.includes('·')) {
                const parts = formula.split('·');
                const main = parseFormula(parts[0]);
                const hydrate = parseFormula(parts[1]);
                
                for (const element in hydrate) {
                    main[element] = (main[element] || 0) + hydrate[element];
                }
                return main;
            }
            
            // Convert to uppercase for easier parsing
            formula = formula.toUpperCase();
            
            const elements = {};
            const stack = [{}];
            let i = 0;
            const n = formula.length;
            
            while (i < n) {
                const c = formula[i];
                
                // Check for opening parenthesis
                if (c === '(' || c === '[' || c === '{') {
                    stack.push({});
                    i++;
                }
                // Check for closing parenthesis
                else if (c === ')' || c === ']' || c === '}') {
                    i++;
                    let count = '';
                    while (i < n && formula[i] >= '0' && formula[i] <= '9') {
                        count += formula[i];
                        i++;
                    }
                    const multiplier = count ? parseInt(count) : 1;
                    
                    const group = stack.pop();
                    const current = stack[stack.length - 1];
                    
                    for (const element in group) {
                        current[element] = (current[element] || 0) + group[element] * multiplier;
                    }
                }
                // Check for uppercase letter (start of element)
                else if (c.match(/[A-Z]/)) {
                    let element = c;
                    i++;
                    
                    // Check for lowercase letters (element symbol continuation)
                    while (i < n && formula[i].match(/[a-z]/)) {
                        element += formula[i];
                        i++;
                    }
                    
                    let count = '';
                    while (i < n && formula[i] >= '0' && formula[i] <= '9') {
                        count += formula[i];
                        i++;
                    }
                    
                    const num = count ? parseInt(count) : 1;
                    const current = stack[stack.length - 1];
                    current[element] = (current[element] || 0) + num;
                }
                // Skip other characters (like dots in hydrates)
                else {
                    i++;
                }
            }
            
            if (stack.length !== 1) return null;
            return stack[0];
        }

        // Format formula with subscripts and superscripts
        function formatFormula(formula) {
            // Handle charge
            if (formula.includes('^')) {
                const parts = formula.split('^');
                const base = parts[0];
                let charge = parts[1];
                
                // Format charge
                if (charge === '+') charge = '⁺';
                else if (charge === '-') charge = '⁻';
                else if (charge === '2+') charge = '²⁺';
                else if (charge === '2-') charge = '²⁻';
                else if (charge === '3+') charge = '³⁺';
                else if (charge === '3-') charge = '³⁻';
                
                return base.replace(/(\d+)/g, '<sub>$1</sub>') + '<sup>' + charge + '</sup>';
            }
            
            // Handle hydrates
            if (formula.includes('·')) {
                const parts = formula.split('·');
                return parts[0].replace(/(\d+)/g, '<sub>$1</sub>') + '·' + parts[1].replace(/(\d+)/g, '<sub>$1</sub>');
            }
            
            return formula.replace(/(\d+)/g, '<sub>$1</sub>');
        }

        // Calculate molar mass
        function calculateMolarMass() {
            const formula = formulaInput.value.trim();
            currentFormula = formula;
            
            // Validate input
            if (!formula) {
                showError("Veuillez entrer une formule chimique");
                return;
            }
            
            // Show loading indicator
            const originalBtnText = calculateBtn.innerHTML;
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calcul...';
            calculateBtn.disabled = true;
            
            // Use setTimeout to allow UI update
            setTimeout(() => {
                try {
                    // Parse formula
                    const parsedFormula = parseFormula(formula);
                    if (!parsedFormula || Object.keys(parsedFormula).length === 0) {
                        throw new Error("Formule chimique invalide ou incomplète");
                    }
                    
                    // Calculate molar mass
                    let totalMass = 0;
                    let stepsHTML = '';
                    let explanationHTML = `
                        <h3>Calcul de la masse molaire de ${formatFormula(formula)}</h3>
                        <p>La masse moléculaire (ou masse molaire) d'une substance est la somme des masses atomiques de tous les atomes qui composent sa formule chimique. Elle s'exprime en grammes par mole (g/mol).</p>
                        <p>Pour calculer la masse moléculaire :</p>
                        <ol>
                            <li>Identifier chaque élément dans la formule</li>
                            <li>Trouver sa masse atomique</li>
                            <li>Multiplier par le nombre d'atomes</li>
                            <li>Additionner toutes les contributions</li>
                        </ol>
                        <h4>Calcul détaillé :</h4>
                        <ul>
                    `;
                    
                    let compositionHTML = '';
                    
                    // First pass to calculate total mass
                    for (const element in parsedFormula) {
                        const elementData = elements.find(e => e.symbol === element);
                        if (!elementData) {
                            throw new Error(`Élément inconnu: ${element}`);
                        }
                        
                        const count = parsedFormula[element];
                        const contribution = elementData.atomicMass * count;
                        totalMass += contribution;
                    }
                    
                    // Second pass to generate steps and percentages
                    for (const element in parsedFormula) {
                        const elementData = elements.find(e => e.symbol === element);
                        const count = parsedFormula[element];
                        const contribution = elementData.atomicMass * count;
                        const percentage = (contribution / totalMass) * 100;
                        
                        stepsHTML += `
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded dark:bg-gray-700">
                                <span class="font-mono">${element}${count > 1 ? `<sub>${count}</sub>` : ''}</span>
                                <span class="text-gray-500">=</span>
                                <span>${count} × ${elementData.atomicMass.toFixed(3)} g/mol</span>
                                <span class="text-gray-500">=</span>
                                <span class="font-bold">${contribution.toFixed(3)} g/mol</span>
                            </div>
                        `;
                        
                        explanationHTML += `
                            <li><span class="element-highlight">${count} atome${count > 1 ? 's' : ''} de ${elementData.name} (${element})</span> : 
                            ${count} × ${elementData.atomicMass.toFixed(3)} g/mol = ${contribution.toFixed(3)} g/mol</li>
                        `;
                        
                        compositionHTML += `
                            <div class="mb-2">
                                <div class="flex justify-between mb-1">
                                    <span class="font-medium">${element} - ${elementData.name}</span>
                                    <span>${percentage.toFixed(2)}%</span>
                                </div>
                                <div class="progress-bar bg-gray-200 dark:bg-gray-700">
                                    <div class="h-full bg-blue-500" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add total step
                    stepsHTML += `
                        <div class="flex justify-between items-center bg-blue-50 p-3 rounded border border-blue-100 dark:bg-blue-900/30 dark:border-blue-800/30">
                            <span class="font-bold">Total</span>
                            <span class="text-gray-500">=</span>
                            <span></span>
                            <span class="text-gray-500">=</span>
                            <span class="font-bold text-blue-700 dark:text-blue-400">${totalMass.toFixed(3)} g/mol</span>
                        </div>
                    `;
                    
                    explanationHTML += `</ul>
                        <p class="font-bold">Masse moléculaire totale : ${totalMass.toFixed(3)} g/mol</p>
                        <h4>Composition massique :</h4>
                        <p>La composition massique indique le pourcentage de masse de chaque élément dans un composé :</p>
                        <ul>
                    `;
                    
                    for (const element in parsedFormula) {
                        const elementData = elements.find(e => e.symbol === element);
                        const count = parsedFormula[element];
                        const contribution = elementData.atomicMass * count;
                        const percentage = (contribution / totalMass) * 100;
                        
                        explanationHTML += `
                            <li><span class="element-highlight">${elementData.name} (${element})</span> : 
                            (${contribution.toFixed(3)} / ${totalMass.toFixed(3)}) × 100 = ${percentage.toFixed(2)}%</li>
                        `;
                    }
                    
                    explanationHTML += `</ul>
                        <h4>Importance en chimie :</h4>
                        <p>La masse moléculaire est essentielle pour :</p>
                        <ul>
                            <li>Calculer les quantités de matière (moles)</li>
                            <li>Préparer des solutions de concentration donnée</li>
                            <li>Équilibrer des équations chimiques</li>
                            <li>Prévoir les quantités dans les réactions</li>
                        </ul>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg dark:bg-blue-900/20">
                            <h4 class="font-bold text-blue-800 dark:text-blue-300"><i class="fas fa-lightbulb mr-2"></i>Conseil pédagogique</h4>
                            <p>La masse atomique n'est pas un nombre entier car elle tient compte de l'abondance naturelle des différents isotopes de chaque élément. Par exemple, le chlore (Cl) a une masse atomique de 35.45 g/mol car il existe sous forme de ³⁵Cl (75%) et ³⁷Cl (25%).</p>
                        </div>
                    `;
                    
                    // Display results
                    formulaDisplay.innerHTML = formatFormula(formula);
                    molarMassDisplay.textContent = totalMass.toFixed(3) + ' g/mol';
                    calculationSteps.innerHTML = stepsHTML;
                    detailedExplanation.innerHTML = explanationHTML;
                    massComposition.innerHTML = compositionHTML;
                    
                    // Render molecule in 3D
                    renderMolecule3D(formula);
                    
                    // Add to history
                    addToHistory(formula, totalMass);
                    
                    // Show results section
                    resultsSection.classList.remove('hidden');
                    inputError.classList.add('hidden');
                    
                    // Scroll to results
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    showError(error.message);
                } finally {
                    calculateBtn.innerHTML = originalBtnText;
                    calculateBtn.disabled = false;
                }
            }, 10);
        }

        // Render elements table
        function renderElementsTable() {
            elementsTableBody.innerHTML = '';
            elements.forEach(element => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-mono font-bold">${element.symbol}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${element.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${element.atomicMass}</td>
                    <td class="px-6 py-4">${element.config}</td>
                `;
                elementsTableBody.appendChild(row);
            });
        }

        // Add calculation to history
        function addToHistory(formula, molarMass) {
            // Check if already in history
            const existingIndex = calculationHistory.findIndex(item => item.formula === formula);
            if (existingIndex !== -1) {
                calculationHistory.splice(existingIndex, 1);
            }
            
            // Add to beginning
            calculationHistory.unshift({
                formula,
                molarMass,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 5 items
            if (calculationHistory.length > 5) {
                calculationHistory.pop();
            }
            
            // Save to localStorage
            localStorage.setItem('molarMassHistory', JSON.stringify(calculationHistory));
            
            // Update UI
            historySection.classList.remove('hidden');
            renderHistory();
        }

        // Render history list
        function renderHistory() {
            historyList.innerHTML = '';
            
            calculationHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item flex justify-between items-center p-3 bg-gray-100 rounded-md dark:bg-gray-700';
                historyItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-mono mr-3">${index + 1}.</span>
                        <span class="formula-display">${formatFormula(item.formula)}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold mr-3">${item.molarMass.toFixed(3)} g/mol</span>
                        <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" onclick="loadFromHistory('${item.formula}')">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // Load formula from history
        function loadFromHistory(formula) {
            formulaInput.value = formula;
            calculateMolarMass();
        }

        // Clear history
        function clearHistory() {
            calculationHistory = [];
            localStorage.removeItem('molarMassHistory');
            historySection.classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            inputError.textContent = message;
            inputError.classList.remove('hidden');
            resultsSection.classList.add('hidden');
        }

        // Toggle explanation section
        function toggleExplanation() {
            explanationContent.classList.toggle('show');
            const icon = explanationToggle.querySelector('i');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }

        // Toggle night mode
        function toggleNightMode() {
            document.documentElement.classList.toggle('dark');
            const icon = nightModeToggle.querySelector('i');
            
            if (document.documentElement.classList.contains('dark')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('nightMode', 'enabled');
                
                // Update Three.js background
                if (scene) scene.background = new THREE.Color(0x1e293b);
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('nightMode', 'disabled');
                
                // Update Three.js background
                if (scene) scene.background = new THREE.Color(0xf8fafc);
            }
        }

        // Toggle exam mode
        function toggleExamMode() {
            isExamMode = !isExamMode;
            const icon = examModeToggle.querySelector('i');
            const inputSection = document.getElementById('inputSection');
            
            if (isExamMode) {
                icon.classList.remove('fa-graduation-cap');
                icon.classList.add('fa-user-graduate');
                inputSection.classList.add('exam-mode');
                alert("Mode examen activé : les aides visuelles sont désactivées");
            } else {
                icon.classList.remove('fa-user-graduate');
                icon.classList.add('fa-graduation-cap');
                inputSection.classList.remove('exam-mode');
            }
        }

        // Check for saved night mode preference
        function checkNightModePreference() {
            if (localStorage.getItem('nightMode') === 'enabled') {
                document.documentElement.classList.add('dark');
                const icon = nightModeToggle.querySelector('i');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                
                // Update Three.js background
                if (scene) scene.background = new THREE.Color(0x1e293b);
            }
        }

        // Show info modal
        function showInfoModal() {
            infoModal.classList.remove('hidden');
        }

        // Hide info modal
        function hideInfoModal() {
            infoModal.classList.add('hidden');
        }
    </script>
</body>
</html>
